
EZworkEra
=============
Utility For Developer of Emuera based game  
readme ver 7.0 2021.07.17
-------------

# About

이 파일은 EZworkEra의 readme 파일로, 현재 존재하는 툴의 기능을 설명하고 있습니다.  

작성 당시 버전명:

* EZworkEra v4.1.1
* convert_helper v1.4.1
* krjp_simple_converter v2.0

### python 버전 관련 참고사항

현재 [releases](https://github.com/SecretU4/EZworkEra/releases)에서 배포되는 패키지 파일은 모두 **python 3.9.2 64bit**를 기반으로 작성되고 있습니다.  
다만 대부분의 코드는 python 3.7.x에서 작성되어 수정되지 않았기 때문에, **windows 7** 등 3.9.x를 지원하지 않는 운영체제라면  <u>main.py를 python 3.7.x로 직접 빌드해 사용</u>해보시는 걸 추천드립니다. 

### **EZworkEra**

*EZworkEra*는 **Emuera** 기반 텍스트 게임(이하 era)에서 사용되는 아래와 같은 파일들의 분석 및 처리를 도와주는 툴입니다.  

* **ERB**  
  *EraBasic*이라 불리는 **Emuera**에서 사용하는 소스 코드가 작성된 파일. 텍스트 에디터를 통해 수정 가능.
* **CSV**  
  **Emuera**에서 사용되는 데이터베이스 저장 양식. 일반적인 *Comma Separated Values*와 같이 `,`를 기준으로 열을 구분하지만 *Excel*과 같이 상용 DB 소프트웨어를 통해 불러오거나 저장할 경우 깨질 수 있음. 텍스트 에디터를 통한 수정 권장
* **ERH**  
  *EraBasic*에서 사용되는 전역 변수/매크로 헤더파일. 일반적인 언어와는 달리 *EraBasic*은 모든 함수를 전역 함수 취급하므로 함수를 헤더 파일 내에 정의하지 않음. 텍스트 에디터를 통해 수정 가능.

era에서 사용되는 파일 이외에도 꿀도르의 사용자 사전 데이터베이스인 `UserDic.json`, `<p>` 태그로 이루어진 웹페이지 게시글(현재 아카라이브만 지원) 내 자료 추출 기능 또한 지원합니다.

또한 *EZworkEra*는 분석/처리된 데이터를 아래와 같은 형식으로 출력하는 기능을 지원합니다.

* **SRS**(`simplesrs`)  
  이미 손/기계번역된 파일이 존재하는 era 파일과 번역되지 않은 era 파일과의 대조를 통해 작성된 **단어 변환 데이터베이스 형식**입니다.  
[*UpdateEra*](https://github.com/SecretU4/UpdateEra)에서 사용하는 일종의 **사용자 사전** 데이터베이스 파일이며, 텍스트 에디터를 통해서도 수정이 가능합니다.
* **ERB**  
  위의 **ERB**와 동일한 파일입니다. 코드 최적화 등 *EraBasic*과 관련된 기능을 통해 처리된 데이터를 본 형식으로 출력할 수 있습니다.
* **txt**  
  Plain Text File을 뜻하는 확장자입니다. 처리된 데이터를 눈으로 볼 수 있도록 텍스트 형식으로 처리하고자 할 때 사용됩니다.
* **xlsx**  
  `~차트 추출`과 같은 기능을 통해 생성된 데이터를 출력할 수 있는 형식 중 하나입니다. 스프레드시트 에디터를 통해 열 수 있습니다.

*EZworkEra*는 <u>**eraTW**의 파일구조를 참고</u>하여 만들어졌습니다.  
따라서 <u>타 era에서의 정상구동을 보장할 수 없는 기능이 존재</u>합니다만, 범용적으로 사용 가능하게 만들기 위해 노력하고 있습니다.  
타 era에서 정상적으로 작동하지 않는 부분이 있다면 [issues](https://github.com/SecretU4/EZworkEra/issues)로 보고 바랍니다.  

현재 버전은 이전(`v2.1`)과는 달리 기능을 각 모듈별로 나눈 후, `main.py`를 통해 기능을 합친 뒤 이를 패키징하여 배포하고 있습니다.  
단, 일부 실험적인 기능이나 메인 모듈에 포함하기 애매한 기능은 스탠드얼론 형식으로 배포하고 있습니다.

현재 *EZworkEra*는 CUI 인터페이스로 작동합니다.

### **convert_helper**

  * *convert_helper*는 **WebP** 이미지 파일의 포맷 변환과 이로 인해 변경되는 **CSV**, **ERB** 파일 내 이미지 파일명을 같이 변환시킬 수 있는 툴입니다.
  * 이와 동시에 작업하는 **CSV**, **ERB** 파일의 언어 인코딩 변환도 지원하고 있습니다.
  * *convert_helper*는 현재 GUI 인터페이스로 작동합니다.

### **krjp_simple_converter**

  * *krjp_simple_converter*는 일판 era 본체와 번역된 era 본체를 활용해
    * 일판 **ERB** 파일을 번역된 era 본체에 이식하거나
    * 번역판 **ERB** 파일을 일판 era 본체에 간편하게 이식할 수 있는 툴입니다.
  * 이를 위해 일판/번역판 각각의 era 본체와 이식하고자 하는 **ERB** 파일 경로가 각각 필요합니다. 
  * *krjp_simple_converter*는 현재 CUI 인터페이스로 작동합니다.

# User Manual

사용 방법의 경우 github의 [wiki](https://github.com/SecretU4/EZworkEra/wiki)에 기술하는 것을 우선적인 목표로 하고 있습니다만, 시간이 될 경우 이곳에도 추가로 기재할 예정입니다.  
_ _ _

## main.py - (EZworkEra 메인 모듈)

현재 *main.py*는 패키징하여 github에 릴리즈시 해당 버전에 맞는 이름으로 바꾸어 올리고 있습니다. zip 패키징을 통해 필요한 파일들을 같이 올리는 경우에는 **main.exe**가 실행 파일입니다.  

**EZworkEra_v4.1.1.exe**  
CUI(콘솔 기반 유저 인터페이스)를 기반으로 한 본 유틸리티의 메인 실행파일입니다.  
해당 실행파일을 구동시 메인메뉴가 출력되고, 여기에서 필요한 기능을 골라 실행해주시면 됩니다.  

### CSV 관련 기능

1. **csv 변수 목록 추출**  
  선택한 폴더 내의 csv를 크롤링한 후 각 csv 파일 내에 선언되어 있는 모든 항목을 추출합니다.  
  `CharaXX.csv`와 같이 캐릭터용 csv 파일은 일반적인 csv 파일과 다른 방식으로 크롤링됩니다.  
  불러온 자료는 python의 `dictionary`형을 활용한 자체 제작 클래스(`InfoDict`)으로 저장되고, 이를 외부 파일로 `sav` 폴더에 저장할 수 있습니다.  
    > ex) `{csv\str.csv: {1:토리이,2:경내,...}`

    단, 일부 csv 파일은 크롤링하지 않습니다. (`gamebase.csv`, `_replace.csv`, `variablesize.csv`)  
    v4.1.1 현재 선택 가능한 메뉴는 다음과 같습니다.
 
    * `구별없이 모두`:  
       선택한 폴더 내의 모든 csv 파일을 불러옵니다. `chara` 관련 csv 파일을 포함합니다.
    * `필터 설정`:  
       수동으로 필요한 옵션을 적용시킬 수 있는 메뉴를 불러옵니다.  
       - `1열/2열 반전`  
       `{1:토리이,2:경내,...}` 형태로 작성되던 자료방식을 `{토리이:1,경내:2,...}` 형태로 작성되게 합니다.
       - `특수형식 csv 미포함`  
       `chara` 관련 csv 파일 (`CharaXX.csv`,`_rename.csv`)을 포함시키지 않고 진행합니다.
    * `SRS 작성용 - 인명`:  
       인명 SRS 작성용으로 `CharaXX.csv` 내의 `NAME`, `CALLNAME` 관련 변수값만을 크롤링합니다.
    * `SRS 작성용 - 변수명`:  
       변수명 SRS 작성용으로 `특수형식 csv 미포함` 상태로 크롤링합니다.
2. **csv 변수 명칭 사전**  
  `{csv변수명:[파일명,번호]}` 형태의 자료를 작성합니다.  
  불러온 디렉토리 내 csv 파일 내에서 선언된 csv변수 목록을 작성할 때 편리합니다.

### ERB 분석 기능

1. **ERB 내 CSV 변수 추출**  
  실행시 `csv 변수 명칭 사전` 기능을 이용하거나 동봉된 `CSVfnclist.csv`를 참조해 CSV 변수목록을 불러온 후, 선택한 폴더의 모든 erb 내에서 해당 변수목록에 해당하는 것들을 검색해 그 결과물을 두 가지 옵션으로 제공합니다.  

    * `CSV당 차트 생성`  
      선택한 폴더 내의 모든 ERB 내애서 사용된 모든 CSV 변수의 목록을 CSV별로 나눠 기록합니다.
    * `ERB당 차트 생성`  
      선택한 폴더 내의 모든 ERB 내애서 사용된 모든 CSV 변수의 목록을 ERB별로 나눠 기록합니다.
  
    ERB 파일별로 출력 가능한 `SheetInfo`형 자료로 저장합니다.  
    검색하려는 erb 파일이 많을수록 시간이 오래 소모됩니다.  
2. **구상 추출**  
  선택한 폴더 내 모든 erb 파일의 `PRINT`, `DATAFORM`으로 된 모든 줄을 검색해 그 결과물을 ERB 파일별로 출력 가능한 `SheetInfo`형 자료로 저장합니다.  
  v4.1.1 현재 선택 가능한 옵션은 다음과 같습니다.

    * `차트 내 중복 자료 제거`
    * `ERB파일당 차트 할당`  
      이 옵션을 비활성화한다면 차트 하나에 모든 추출된 데이터가 포함되어 출력된 xlsx 자료의 로딩 시간에 영향을 줄 수 있습니다.
    * `공백을 포함하지 않음`  
      `PRINTFORML ` 과 같이 내용 없는 출력문을 제외합니다.
    * `주석추출 모드`  
      `;`를 포함하는 모든 줄(출력문과 출력문이 아닌 줄 모두 포함)을 추출합니다.
3. **ERB형 데이터베이스 추출**  
  선택한 폴더 내 erb 파일에서 특정 형식으로 된 데이터베이스를 필터링할 수 있는 기능입니다.  
  한 줄씩으로 이루어진 데이터만 지원하며, `CASE`로 제어되는 경우 srs화시 더 정확하게 치환될 수 있도록 하는 기능을 지원합니다.
  eraTW의 선물데이터나 캐릭터데이터 등을 처리할 때 유용하게 사용할 수 있습니다.

### ERB 처리 기능

1. **들여쓰기 교정**  
  선택한 폴더 내의 erb를 크롤링해 구조화한 뒤 `IF` 구문과 `CASE` 구문, `DATALIST` 구문을 바탕으로 들여쓰기를 교정해 출력합니다. 해당 과정에서 외부 파일로 크롤링한 erb 파일의 처리결과를 `InfoDict`형 자료로 sav 폴더에 저장할 수 있습니다.

    자료 원본 예시:  

    ```basic
    IF LOCAL  
    IF TARGET:ARG:1  
    PRINTFORMW 테스트입니다.  
    ELSE  
    PRINTFORML TEST입니다.  
    ENDIF  
    ENDIF
    ```

    자료 결과물 `Infodict`자료형 예시:  

    ```python
    {filename.erb:
    [
      [0,0,0,'IF LOCAL'],
      [1,0,0,'IF TARGET:ARG:1'],
      [2,0,0,'PRINTFORMW 테스트입니다'],
      [1,0,0,'ELSE'],
      [2,0,0,'TEST입니다'],
      [1,0,0,'ENDIF'],
      [0,0,0,'ENDIF']
      ]
    }
    ```

    자료 결과물 예시:

    ```basic
    IF LOCAL  
      IF TARGET:ARG:1  
        PRINTFORMW 테스트입니다.  
      ELSE  
        PRINTFORML TEST입니다.  
      ENDIF  
    ENDIF
    ```

2. **구상 번역기**  
  특정한 문법을 이용해 작성한 txt 파일을 양식에 맞는 ERB 파일로 변환해주는 툴입니다.  
  v3.7.0 현재 특정한 문법이 확정되지 않아 사실상 이용할 수 없으며 추후 기능이 삭제/변경 될 수 있습니다.
3. **ERB 내 CSV 인덱스 변환**  
  `csv 변수 출력`의 결과물이나 구동 중 분석을 통해 csv 데이터를 만든 후 해당 데이터를 바탕으로 선택한 폴더 내의 모든 erb 내에서 숫자/변수명으로 된 csv 변수를 변수명/숫자로 변환해 `InfoDict`형 자료로 저장하는 기능입니다. csv 데이터가 올바르지 않은 경우 정상적인 작동을 보장할 수 없습니다.  

    작동 원본 CSV 예시:  
    >FLAG.csv
    >>1,사과  
      2,바나나;노랗거나 초록색이거나  
      3,빨강

    작동 원본 ERB 예시:
    >Origin.erb
    >>IF FLAG:사과 == 1:  
    PRINT 빨간 사과  
    ELSEIF FLAG:2 == 0:  
    PRINT 노란 바나나

    작동 결과 예시 - 변수를 숫자로:
    >Trans.erb
    >>IF FLAG:1 == 1:  
    PRINT 빨간 사과  
    ELSEIF FLAG:2 == 0:  
    PRINT 노란 바나나

4. **불완전 수식 정리**  
    ERB 파일 내 문법 문제가 발생하는 부분을 자동으로 수정해주는 툴입니다. v3.7.0 현재 일부 기능만 지원합니다.
    * `중첩 PRINTDATA 변환`:  
    `PRINTDATA` 구문 내부에 `PRINTDATA`가 있는 경우 이를 `CASE`문으로 변환시켜줍니다.
5. **구상 메모리 최적화**  
    [이 게시글](https://arca.live/b/textgame/9468253)의 템플릿 형식을 기반으로 ERB의 형식을 자동으로 변환시켜주는 툴입니다. v4.1.1 현재 일부 기능만 지원합니다.  
    인식 가능한 출력 명령문: `PRINT(V|S|FORM|FORMS|)(C|LC|)(K|D|)(L|W|)`  
    * 인식이 가능하다고 해도, 본 기능을 사용해 출력할 때에는 `PRINTFORM(L|W)`의 꼴로 출력됩니다.

### ERH 관련 기능

아직 껍데기만 있습니다. 현재 개발중에 있습니다.

### 외부 데이터 처리 기능

일반적인 에라에서는 사용되지 않지만 에라와 관련된 파일을 다룰 때 도움이 되는 외부 파일들의 처리와 관련된 기능입니다.

1. **UserDic.json srs화**  
  꿀도르 등 *EZTrans* 기반 번역기의 사용자 사전 (`UserDic.json`)을 *UpdateEra*에서 사용하는 SRS 형식으로 변환해주는 툴입니다.
2. **웹 게시글 txt화**  
  웹 상에 게시된 글을 그대로 복사/붙여넣기 시 지나친 개행이 발생하는 현상 없이 게시된 글 형태를 txt 형태로 저장해주는 툴입니다.  
  현재 아카라이브 내 게시글에서만 작동합니다.

### 결과물 처리 기능

*EZworkEra*로 생성했던 자료나 이를 외부 파일로 저장한 것을 불러와 아래의 양식에 맞게 출력해줍니다.  
결과물은 기본적으로 실행 파일이 있는 폴더의 `ResultFiles` 폴더에 저장됩니다.

1. **결과물 TXT화**  
  생성된 자료를 TXT 파일로 출력합니다. 해당 자료가 `InfoDict`자료형으로 저장되어있던 경우, TXT 출력물을 원본폴더 또는 `ResultFiles`폴더로 저장할 수 있습니다. 단 원본폴더에 저장하는 경우나 이미 해당 작업의 결과물이 폴더에 있을 경우 원본/이전 데이터가 유실될 수 있습니다.
2. **결과물 ERB화**  
  생성된 자료를 ERB 파일로 출력합니다. 기능적으로는 TXT 파일 출력과 동일하나 확장자를 자동으로 바꿔줍니다.  
  해당 자료가 `InfoDict`자료형으로 저장되어있던 경우, ERB 출력물을 원본폴더 또는 `ResultFiles`폴더로 저장할 수 있습니다. 단 원본폴더에 저장하는 경우나 이미 해당 작업의 결과물이 폴더에 있을 경우 원본/이전 데이터가 유실됩니다.
3. **결과물 SRS화**  
  생성된 자료 두 개를 합쳐 SRS 파일로 출력합니다. 파일명을 설정하지 않을 경우 `autobuild.simplesrs`이라는 이름의 파일이 생성됩니다.  
  현재 `CSV 변수 출력` 기능으로 생성된 자료형에 대응하여 설계되어 있으며, 두 자료의 합이 맞지 않으면 SRS 파일 내와 `output.log` 파일에 관련 내용이 기록됩니다. 같은 이름의 SRS 파일이 있다면 해당 파일 최하단에 이어쓰게 됩니다.  
  본 기능에서 지원하는 옵션은 다음과 같습니다.
    * `미번역(영어 포함) 단어 제외` : 입력받은 두 자료 내 특정 항목이 서로 동일한 경우 해당 항목을 `SRS`에 작성하지 않고 건너뜁니다.
    * `짧은 단어(1글자) 제외` : 입력받은 두 자료 중 `원본`쪽의 특정 항목이 한 글자짜리인 경우 해당 항목을 `SRS`에 작성하지 않고 건너뜁니다.
    * `CSV 표적화 기능(CSV 변수만 변환할 수 있음)` : ERB 내 존재하는 CSV 변수만 변환시킬 수 있도록 `SRS` 작성시 각 항목 앞에 `:`을 추가합니다.
4. **결과물 xlsx화**  
  `SheetInfo`형으로 생성되는 결과물을 xlsx, 즉 엑셀 파일 형태로 출력합니다.  
  커뮤니티 번역 등의 용도로 사용할 수 있습니다.

_ _ _

## convert_helper.py (convert_helper v1.4.1)

현재 **ezEmuera**, **uEmuera** 구버전 등 **emuera1824** 버전을 기반으로 한 era 실행기(중 구버전)가 webp 등의 리소스 확장자를 지원하지 않아 최근까지 개발되고 있는 파생 era를 제대로 지원하지 못하는 문제가 있습니다.  
이와 관련된 호환성 지원을 위해 리소스 파일의 format 및 관련 내용 수정을 지원하는 툴이 *convert_helper*입니다.  
편의성을 위해 GUI(PySide2 사용)를 지원합니다. 따라서 <u>사용시 PySide2의 dll 파일이 필요</u>합니다. (v1.4.1 현재 본 exe 파일이 있는 폴더의 `dll/` 디렉토리에 Qt의 `plugins/` 내 dll 폴더들이 위치해야 합니다. 일반적 이용시 본 레포지토리의 `dll/` 폴더를 붙여넣으시면 됩니다.)

* `Select Directory`  
파일 처리를 실행할 디렉토리를 설정할 수 있습니다. 에라 배포판 폴더(ex: eraTW, eraTWKR)를 선택하시면 됩니다.
* `Encode to`  
선택한 디렉토리 내의 텍스트 기반 파일들(ERB, ERH, CSV 지원)을 어떤 인코딩으로 일괄 변경할지를 선택합니다. 실행 전 해당 기능을 사용할지 선택할 수 있습니다.
* `Convert image from/to`  
선택한 디렉토리 내의 from에서 선택한 포맷(확장자) 파일을 to에서 선택한 포맷(확장자) 파일로 일괄 변경합니다. 단순히 확장자를 변경하는 것이 아닌 포맷 변환을 통해 작동합니다. 실행 전 해당 기능을 사용할지 선택할 수 있습니다.
* `Option`  
  * `Change image ext in CSV/ERB`
  선택한 디렉토리 내의 텍스트 기반 파일들(ERB, ERH, CSV 지원) 내부 작동 코드에서 `image from` 으로 되어있던 확장자 부분을 `image to` 확장자로 치환합니다. `Encode to` 미선택시 작동하지 않습니다. `Encode to`만 선택 후 작동시 오류가 발생할 수 있습니다.
  * `Place files in Result directory`  
  해당 옵션 미선택시 선택한 디렉토리 내의 파일 처리시 원본이 소실됩니다. (덮어쓰기 처리됩니다)  
  해당 옵션 선택시 `convert_helper.exe`가 위치한 폴더의 하위폴더로 `Result\`가 생기며 결과물이 그 안에 들어갑니다.

## krjp_simple_converter.py (krjp_simple_converter v2.0)

*krjp_simple_converter*는 일판 era 본체와 번역된 era 본체를 활용해

  * 일판 **ERB** 파일을 번역된 era 본체에 이식하거나
  * 번역판 **ERB** 파일을 일판 era 본체에 간편하게 이식할 수 있는 툴입니다.

주로 타 언어판의 구상 파일을 이식하고자 할 때 유용하게 사용하실 수 있습니다.  
본 기능을 사용하기 위해선

1. 일판/번역판 각각의 era 본체(ERB, CSV, ERH 포함)
2. 이식하고자 하는 **ERB** 파일 경로가 각각 필요합니다. 

본 툴을 통해서 ERB 내 CSV 변수를 index값이나 (해당 데이터가 존재하는 경우) 타 언어판에 해당하는 값으로 자동 변경하는 기능을 이용하실 수 있으며, 해당 ERB 내 코드가 사용중인 외부/전역 변수나 함수 등을 알 수 있습니다.

_ _ _

# 오류, 개선 등 보고 관련하여

현재 github의 본 [Repository](https://github.com/SecretU4/EZworkEra/) 내 [Issue Tracker](https://github.com/SecretU4/EZworkEra/issues)에서 보고 가능하며, 이쪽이 이메일과 알림이 연동되어 더 빠른 답변이 가능합니다.  
또는 아카라이브 [텍스트게임 채널](https://arca.live/b/textgame)의 **버그_제보** 말머리에 **EZworkEra**가 포함된 제목을 달아주시면 확인 가능합니다.

# 작성 로그

* ver 1.0
  * 'chara CSV 이름추출', 'CSV 이름 srs 변환 구동'의 설명 작성
  * readme 파일 작성

* ver 2.0
  * 'chara CSV 이름추출', 'CSV 이름 srs 변환 구동' 설명 및 패키지 파일 제거  
  * 'trans_csv_to_srs' 설명 작성  
  * readme 관련 내용 수정 및 개정  

* ver 2.1  
  * readme 파일 마크다운 문법에 맞게 가독성 개선  

* ver 3.0  
  * github 프로젝트 내 위키로 사용법 이슈 트레커 이관 등의 readme 개정  

* ver 3.1  
  * 부족했던 부분 가필

* ver 4.0  
  * EZworkEra v3.6.1, convert_helper v1.0 에 맞게 readme 개정
  * markdown 문법에 맞게 가독성 개선

* ver 5.0
  * EZworkEra v3.7.0에 맞게 readme 개정
  * 각 툴별 개요 추가

* ver 6.0
  * EZworkEra v4.0.0에 맞게 readme 개정
  * 일부 중요하지 않은 추가기능이 누락되어 있음.

* ver 7.0
  * EZworkEra v4.1.0에 맞게 readme 개정
  * readme 구조 변경

# 개발자 발언대

* ver 2.1? 2019/10/08

  현재 기여자가 프로젝트 관리자인 저밖에 없는 관계로 생각보다 코드 갈아엎기나 모듈 분할 같은 일을 자주 만들고 있습니다. 따라서 만약. 마안약에 기여를 하시고자 할 때에는 되도록 브랜치를 따로 하셔야 나중에 통합할 때 편할 것 같습니다. 어차피 통합도 제가 하니 마음 편하게 가지시고 참여해주시면 감사하겠습니다.

* ver 4.0 2020/06/17

  마지막으로 이 파일을 수정한지 벌써 6개월이 넘었더군요. 그동안 바뀐 부분도 있고 해서 이번 기회에 수정했습니다. 여러분들의 많은 이용과 오류 보고 부탁드립니다.
